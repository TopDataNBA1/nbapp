<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP DATA NBA LIVE</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body{margin:0;padding:0;background:#0f0f1b;color:#e0e0e0;font-family:'Roboto',sans-serif;min-height:100vh;}
        .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:rgba(0,0,0,0.9);border-bottom:3px solid #ff4655;}
        .logo-img{height:60px;width:auto;}
        .nbapp{font-family:'Orbitron',sans-serif;font-size:2.4em;color:#ff4655;text-shadow:0 0 10px #ff4655;font-weight:700;}
        .status-bar{padding:8px 20px;background:rgba(0,0,0,0.7);font-size:1.1em;text-align:center;}
        .status-line1{color:#55ff55;}
        .status-line2{color:#ffaa00;font-weight:600;}

        .tabs{max-width:900px;margin:15px auto;display:flex;border-radius:10px;overflow:hidden;box-shadow:0 4px 15px rgba(255,70,85,0.3);}
        .tab-btn{flex:1;padding:12px 8px;font-family:'Orbitron',sans-serif;font-size:1.1em;color:white;background:rgba(255,70,85,0.2);border:none;cursor:pointer;transition:0.3s;}
        .tab-btn:hover{background:rgba(255,70,85,0.4);}
        .tab-btn.active{background:#ff4655;box-shadow:0 0 12px #ff4655;}

        .tab-content{display:none;background:rgba(20,20,40,0.97);padding:10px;border-radius:0 0 10px 10px;}
        .tab-content.active{display:block;}
        .container{max-width:900px;margin:0 auto;}

        /* LATEST MOVES */
        .moves-area{height:88vh;background:#1e1e2e;border-radius:16px;overflow:hidden;box-shadow:0 12px 40px rgba(255,70,85,0.4);display:flex;flex-direction:column;}
        .moves-list{flex:1;overflow-y:auto;padding:18px 12px;background:#0f0f1b;}
        .move-item{background:rgba(30,30,46,0.9);border-radius:14px;margin:14px 8px;padding:16px 14px;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
        .move-text{font-size:1.01em;line-height:1.52;color:#e0e0e0;text-align:center;}
        .move-text strong{color:#ffaa00;font-weight:700;}
        .move-time{color:#888;font-size:0.89em;text-align:center;margin-top:10px;font-style:italic;}

        /* COLLAGES */
        .collage { max-width: 300px; max-height: 200px; margin: 0 auto 12px; border-radius: 10px; overflow: hidden; }
        .collage img { width: 100%; height: 100%; object-fit: cover; }
        .collage.c2 { display: flex; gap: 6px; }
        .collage.c2 img { flex: 1; }
        .collage.c3 { display: flex; gap: 6px; height: 200px; }
        .collage.c3 .left, .collage.c3 .right { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .collage.c3 img { flex: 1; width: 100%; }
        .collage.c4 { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; height: 200px; }

        /* LIVE RANKINGS */
        .filters{display:flex;gap:10px;margin:12px 0;justify-content:center;padding:4px 0;overflow-x:auto;}
        .filter-btn{white-space:nowrap;padding:6px 11px;background:rgba(255,70,85,0.25);border:1px solid #ff4655;border-radius:6px;font-family:'Orbitron',sans-serif;font-size:0.86em;cursor:pointer;transition:0.3s;}
        .filter-btn.active{background:#ff4655;box-shadow:0 0 10px #ff4655;font-weight:bold;}

        .card{background:rgba(20,20,40,0.97);border-radius:8px;overflow:hidden;margin:10px 0;box-shadow:0 4px 12px rgba(0,0,0,0.6);}
        .card h2{margin:0;padding:8px;font-family:'Orbitron',sans-serif;font-size:1.15em;background:#ff4655;color:white;text-align:center;}
        table{width:100%;border-collapse:collapse;font-size:0.84em;}
        th,td{padding:5px 4px;border-bottom:1px solid #333;}
        th{background:#1a1a2e;position:sticky;top:0;font-size:0.88em;}
        .rank{color:#ffaa00;text-align:center;font-weight:bold;width:8%;}
        .player{text-align:left;font-weight:500;width:28%;}
        .today{font-weight:bold;width:12%;}
        .diff{color:#ffaa00;width:10%;}
        .diff-blink{color:#ffaa00!important;font-weight:900;animation:blink 1.6s infinite;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
        .leyenda{text-align:center;padding:10px;background:rgba(255,70,85,0.15);border:1px solid #ff4655;border-radius:8px;font-size:0.9em;margin:10px 0;}

        /* PANEL DE CONFIGURACIÓN */
        .settings-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; }
        .settings-panel.open { display: flex; }
        .settings-header { background: #ff4655; padding: 15px; text-align: center; font-family: 'Orbitron', sans-serif; }
        .settings-header h2 { margin: 0; color: white; }
        .settings-tabs { display: flex; background: #1e1e2e; }
        .settings-tab-btn { flex: 1; padding: 12px; background: rgba(255,70,85,0.2); border: none; color: white; font-size: 1em; cursor: pointer; }
        .settings-tab-btn.active { background: #ff4655; color: black; }
        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-tab-content { display: none; }
        .settings-tab-content.active { display: block; }
        .filter-group { margin-bottom: 20px; }
        .filter-group h4 { margin: 10px 0 8px 0; color: #ffaa00; }
        .filter-option { display: block; width: 100%; margin: 8px 0; padding: 10px; background: rgba(255,70,85,0.2); border: 1px solid #ff4655; color: white; text-align: center; cursor: pointer; border-radius: 6px; }
        .filter-option.active { background: #ff4655; color: black !important; box-shadow: 0 0 12px #ff4655; }
        .none-btn { background: #333 !important; border-color: #888 !important; }
        #close-settings { background: #ff4655; color: white; border: none; padding: 15px; font-size: 1.1em; cursor: pointer; }
    </style>
</head>
<body>

    <div class="topbar">
        <img src="logo.jpg" alt="Logo" class="logo-img">
        <div class="nbapp">NBApp</div>
        <button id="settings-btn" style="background:none;border:none;color:#ff4655;font-size:1.8em;cursor:pointer;">⚙️</button>
    </div>

    <div class="status-bar">
        <div class="status-line1">ONLINE - Last update:</div>
        <div class="status-line2" id="clock-line">--:--:-- ET • --:--:-- CEST</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('telegram')">Latest Moves</button>
        <button class="tab-btn" onclick="openTab('live')">Live Rankings</button>
    </div>

    <div id="telegram" class="tab-content active">
        <div class="container">
            <div class="moves-area">
                <div class="moves-list">
                    <div id="moves-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="live" class="tab-content">
        <div class="container">
            <div class="leyenda">
                Today column: <span style="color:white">game finished</span> • 
                <span style="color:#ffaa00;text-shadow:0 0 8px #ffaa00">playing now</span> • 
                <span style="color:#888">not started</span> • 
                <span style="color:#ff5555">inactive</span>
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="top25">Top 25</button>
                <button class="filter-btn" data-filter="top100">Top 100</button>
                <button class="filter-btn" data-filter="playing">Playing</button>
                <button class="filter-btn" data-filter="almost">Almost</button>
            </div>
            <div id="tables"></div>
        </div>
    </div>

    <div id="settings-panel" class="settings-panel">
        <div class="settings-header"><h2>Configuración</h2></div>
        <div class="settings-tabs">
            <button class="settings-tab-btn active" data-tab="tab-push">Push Notifications</button>
            <button class="settings-tab-btn" data-tab="tab-latest">Latest Moves View</button>
        </div>
        <div class="settings-content">
            <div class="settings-tab-content active" id="tab-push">
                <p style="text-align:center; font-size:0.8em; color:#888;">(Configuración para notificaciones del sistema)</p>
            </div>

            <div class="settings-tab-content active" id="tab-latest">
                <button class="filter-option active" data-group="latest-global" data-value="ALL">ALL (Show Everything)</button>
                <hr style="border-color:#ff4655;margin:20px 0;">
                <div class="filter-group">
                    <h4>Top</h4>
                    <button class="filter-option active" data-group="latest-amount" data-value="all">All</button>
                    <button class="filter-option" data-group="latest-amount" data-value="top100">Top 100</button>
                    <button class="filter-option" data-group="latest-amount" data-value="top25">Top 25</button>
                </div>
                <div class="filter-group">
                    <h4>Stat</h4>
                    <button class="filter-option active" data-group="latest-stat" data-value="all">All</button>
                    <button class="filter-option" data-group="latest-stat" data-value="pts">PTS</button>
                    <button class="filter-option" data-group="latest-stat" data-value="trb">REB</button>
                    <button class="filter-option" data-group="latest-stat" data-value="ast">AST</button>
                    <button class="filter-option" data-group="latest-stat" data-value="stl">STL</button>
                    <button class="filter-option" data-group="latest-stat" data-value="blk">BLK</button>
                    <button class="filter-option" data-group="latest-stat" data-value="fg3">3P</button>
                    <button class="filter-option" data-group="latest-stat" data-value="g">GAMES</button>
                </div>
                <div class="filter-group">
                    <h4>Type</h4>
                    <button class="filter-option active" data-group="latest-type" data-value="all">All</button>
                    <button class="filter-option" data-group="latest-type" data-value="milestone">Milestones</button>
                    <button class="filter-option" data-group="latest-type" data-value="overtake">Overtaking</button>
                </div>
                <button class="filter-option none-btn" data-group="latest-none">None (Mute View)</button>
            </div>
        </div>
        <button id="close-settings">Close</button>
    </div>

    <script>
        // --- UTILIDADES ---
        function getTimes() {
            const now = new Date();
            const cest = now.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:'Europe/Paris'});
            const est = now.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZone:'America/New_York'});
            return {cest, est};
        }

        function timeAgo(ts) {
            const now = Date.now() / 1000;
            const diff = Math.floor(now - ts);
            if (diff < 60) return "now";
            if (diff < 3600) return Math.floor(diff / 60) + "m ago";
            if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
            return Math.floor(diff / 86400) + "d ago";
        }

        // --- NAVEGACIÓN ---
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'live') updatePage();
            if (tabName === 'telegram') updateMoves();
        }

        // --- PASO 2: LÓGICA DE FILTRADO PARA LATEST MOVES ---
        function getActiveLatestFilters() {
            const isGlobalAll = document.querySelector('[data-group="latest-global"][data-value="ALL"]').classList.contains('active');
            if (isGlobalAll) return "ALL";

            const isNone = document.querySelector('[data-group="latest-none"]').classList.contains('active');
            if (isNone) return "NONE";

            return {
                top: document.querySelector('[data-group="latest-amount"].active').dataset.value,
                stats: Array.from(document.querySelectorAll('[data-group="latest-stat"].active')).map(b => b.dataset.value),
                types: document.querySelector('[data-group="latest-type"].active').dataset.value
            };
        }

        function updateMoves() {
            const list = document.getElementById('moves-list');
            if (!list) return;

            fetch('data.json?v=' + new Date().getTime())
                .then(r => r.json())
                .then(data => {
                    const filters = getActiveLatestFilters();
                    if (filters === "NONE") {
                        list.innerHTML = '<div style="text-align:center;color:#888;padding:50px;">View Muted (Check Settings)</div>';
                        return;
                    }

                    let notis = (data.notificaciones || []).reverse();

                    // Aplicar filtros si no es "ALL"
                    if (filters !== "ALL") {
                        notis = notis.filter(n => {
                            // Filtrar por TOP
                            if (filters.top === 'top25' && n.rank > 25) return false;
                            if (filters.top === 'top100' && n.rank > 100) return false;

                            // Filtrar por STAT (si hay stats seleccionadas y no es 'all')
                            if (!filters.stats.includes('all') && !filters.stats.includes(n.stat)) return false;

                            // Filtrar por TIPO (Milestone / Overtake)
                            if (filters.types !== 'all' && n.type !== filters.types) return false;

                            return true;
                        });
                    }

                    if (notis.length === 0) {
                        list.innerHTML = '<div style="text-align:center;color:#888;padding:50px;">No moves match your filters...</div>';
                        return;
                    }

                    list.innerHTML = notis.map(n => {
                        const fotos = Array.isArray(n.foto) ? n.foto : (n.foto ? [n.foto] : []);
                        const cuando = n.timestamp ? timeAgo(n.timestamp) : "";
                        let collageHtml = '';

                        if (fotos.length === 1) collageHtml = `<div class="collage c1"><img src="${fotos[0]}"></div>`;
                        else if (fotos.length === 2) collageHtml = `<div class="collage c2"><img src="${fotos[0]}"><img src="${fotos[1]}"></div>`;
                        else if (fotos.length === 3) collageHtml = `<div class="collage c3"><div class="left"><img src="${fotos[0]}"></div><div class="right"><img src="${fotos[1]}"><img src="${fotos[2]}"></div></div>`;
                        else if (fotos.length >= 4) collageHtml = `<div class="collage c4">${fotos.slice(0,4).map(f=>`<img src="${f}">`).join('')}</div>`;

                        return `
                            <div class="move-item">
                                ${collageHtml}
                                <div class="move-text">${n.texto}</div>
                                <div class="move-time">${cuando}</div>
                            </div>`;
                    }).join('');
                })
                .catch(() => {
                    list.innerHTML = '<div style="text-align:center;color:#888;padding:50px;">Waiting for action...</div>';
                });
        }

        // --- LIVE RANKINGS (Mantenido igual) ---
        const statNames = {pts:"NBA All-Time Points",trb:"NBA All-Time Rebounds",ast:"NBA All-Time Assists",stl:"NBA All-Time Steals",blk:"NBA All-Time Blocks",fg3:"NBA All-Time Three-Pointers",g:"NBA All-Time Games Played"};

        function updatePage() {
            const {cest, est} = getTimes();
            document.getElementById('clock-line').textContent = `${est} ET • ${cest} CEST`;

            fetch('data.json?v=' + new Date().getTime())
                .then(r => r.json())
                .then(data => {
                    const tablesDiv = document.getElementById('tables');
                    tablesDiv.innerHTML = '';
                    const f = {
                        top25: document.querySelector('[data-filter="top25"]').classList.contains('active'),
                        top100: document.querySelector('[data-filter="top100"]').classList.contains('active'),
                        playing: document.querySelector('[data-filter="playing"]').classList.contains('active'),
                        almost: document.querySelector('[data-filter="almost"]').classList.contains('active'),
                        all: document.querySelector('[data-filter="all"]').classList.contains('active')
                    };

                    for (const [stat, tabla] of Object.entries(data.tablas || {})) {
                        let filtered = tabla.filter(row => {
                            if (f.top25 && row.Rank > 25) return false;
                            if (f.top100 && !f.top25 && row.Rank > 100) return false;
                            if (f.playing && row.game_status !== 'playing') return false;
                            if (f.almost) {
                                const diff = String(row.Diff).trim();
                                const near = (stat === 'pts') ? ['0','1','2'] : ['0'];
                                if (!near.includes(diff)) return false;
                            }
                            return true;
                        });

                        if (filtered.length === 0) continue;

                        const card = document.createElement('div'); card.className = 'card';
                        card.innerHTML = `<h2>${statNames[stat]}</h2><table><thead><tr><th>Rank</th><th>Player</th><th>Team</th><th>Today</th><th>Total</th><th>Diff</th><th>Ahead</th></tr></thead><tbody></tbody></table>`;
                        const tbody = card.querySelector('tbody');

                        filtered.forEach(row => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="rank">${row.Rank}</td>
                                <td class="player">${row.Nombre}</td>
                                <td class="team">${row.Team}</td>
                                <td class="today" style="${row.game_status==='playing'?'color:#ffaa00;font-weight:900;':''}">${row.Hoy ?? 0}</td>
                                <td class="number"><strong>${Number(row.Total).toLocaleString()}</strong></td>
                                <td class="diff">${row.Diff}</td>
                                <td>${row.Antece||'-'}</td>`;
                            tbody.appendChild(tr);
                        });
                        tablesDiv.appendChild(card);
                    }
                });
        }

        // --- GESTIÓN DE PANEL SETTINGS ---
        document.getElementById('settings-btn').addEventListener('click', () => document.getElementById('settings-panel').classList.add('open'));
        document.getElementById('close-settings').addEventListener('click', () => {
            document.getElementById('settings-panel').classList.remove('open');
            updateMoves(); // Actualizar al cerrar por si cambió algo
        });

        document.querySelectorAll('.settings-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.settings-tab-btn, .settings-tab-content').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        document.querySelectorAll('.filter-option').forEach(opt => {
            opt.addEventListener('click', () => {
                const group = opt.dataset.group;
                
                if (opt.dataset.value === 'ALL') {
                    document.querySelectorAll(`[data-group^="${group.split('-')[0]}"]`).forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                } else if (group.includes('none')) {
                    document.querySelectorAll(`[data-group^="${group.split('-')[0]}"]`).forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                } else if (group.endsWith('-amount') || group.endsWith('-type')) {
                    document.querySelectorAll(`[data-group="${group}"]`).forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    document.querySelector(`[data-group="${group.split('-')[0]}-global"]`)?.classList.remove('active');
                    document.querySelector(`[data-group="${group.split('-')[0]}-none"]`)?.classList.remove('active');
                } else {
                    opt.classList.toggle('active');
                    const allBtn = document.querySelector(`[data-group="${group}"][data-value="all"]`);
                    if (opt.dataset.value !== 'all') allBtn.classList.remove('active');
                    if (document.querySelectorAll(`[data-group="${group}"].active`).length === 0) allBtn.classList.add('active');
                    document.querySelector(`[data-group="${group.split('-')[0]}-global"]`)?.classList.remove('active');
                    document.querySelector(`[data-group="${group.split('-')[0]}-none"]`)?.classList.remove('active');
                }
            });
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updatePage();
            });
        });

        setInterval(() => {
            if (document.getElementById('telegram').classList.contains('active')) updateMoves();
            if (document.getElementById('live').classList.contains('active')) updatePage();
        }, 30000);

        updatePage();
        updateMoves();
    </script>
</body>
</html>