<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Rankings Live - Top Data NBA</title>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .notification-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification-banner.success {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
        }

        .notification-banner button {
            background: white;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .notification-banner button:hover {
            transform: scale(1.05);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .latest-moves {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .latest-moves h2 {
            font-size: 2em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #ffd43b;
            animation: slideIn 0.3s ease-out;
        }

        .notification-item.new {
            background: rgba(255, 212, 59, 0.2);
            border-left-color: #ffd43b;
            box-shadow: 0 0 20px rgba(255, 212, 59, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timestamp {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .notification-text {
            font-size: 1.1em;
            line-height: 1.4;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #ff4444;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin-left: 10px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .update-time {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÄ NBA Rankings Live</h1>
            <p>Seguimiento en tiempo real de los mejores jugadores de la NBA</p>
            <div class="update-time" id="updateTime">Cargando datos...</div>
        </header>

        <!-- Banner de notificaciones -->
        <div id="notificationBanner" class="notification-banner hidden">
            <span id="notificationMessage"></span>
            <button id="enableNotifications">Activar Notificaciones</button>
        </div>

        <!-- Latest Moves -->
        <div class="latest-moves">
            <h2>
                üì¢ Latest Moves
                <span class="live-indicator"></span>
            </h2>
            <div id="latestMoves" class="loading">
                Cargando movimientos recientes...
            </div>
        </div>

        <!-- Tablas de estad√≠sticas -->
        <div class="stats-container" id="statsContainer">
            <div class="loading">Cargando estad√≠sticas...</div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN DE ONESIGNAL
        // ============================================
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        
        OneSignalDeferred.push(async function(OneSignal) {
            // IMPORTANTE: Reemplaza con tu App ID de OneSignal
            await OneSignal.init({
                appId: "TU_ONESIGNAL_APP_ID", // ‚Üê CAMBIAR ESTO
                safari_web_id: "web.onesignal.auto.xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx", // Si usas Safari
                notifyButton: {
                    enable: false, // Usaremos nuestro propio bot√≥n
                },
                allowLocalhostAsSecureOrigin: true, // Para desarrollo local
            });

            // Comprobar el estado de las notificaciones
            const permission = await OneSignal.Notifications.permission;
            updateNotificationBanner(permission);

            // Escuchar cambios en el permiso
            OneSignal.Notifications.addEventListener('permissionChange', function(isPermitted) {
                updateNotificationBanner(isPermitted);
            });

            // Evento cuando se recibe una notificaci√≥n
            OneSignal.Notifications.addEventListener('click', function(event) {
                console.log('Notificaci√≥n clickeada:', event);
                // Puedes a√±adir l√≥gica adicional aqu√≠
            });
        });

        // ============================================
        // GESTI√ìN DEL BANNER DE NOTIFICACIONES
        // ============================================
        function updateNotificationBanner(isPermitted) {
            const banner = document.getElementById('notificationBanner');
            const message = document.getElementById('notificationMessage');
            const button = document.getElementById('enableNotifications');

            if (isPermitted) {
                banner.classList.add('success');
                banner.classList.remove('hidden');
                message.textContent = '‚úì ¬°Notificaciones activadas! Recibir√°s alertas de nuevos movimientos.';
                button.style.display = 'none';
            } else {
                banner.classList.remove('success', 'hidden');
                message.textContent = 'üîî Activa las notificaciones para recibir alertas de nuevos movimientos en tiempo real';
                button.style.display = 'block';
            }
        }

        // Bot√≥n para activar notificaciones
        document.getElementById('enableNotifications').addEventListener('click', async function() {
            OneSignalDeferred.push(async function(OneSignal) {
                await OneSignal.Notifications.requestPermission();
            });
        });

        // ============================================
        // CARGA Y ACTUALIZACI√ìN DE DATOS
        // ============================================
        let lastNotificationCount = 0;

        async function loadData() {
            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`data.json?t=${timestamp}`);
                const data = await response.json();

                // Actualizar hora de actualizaci√≥n
                document.getElementById('updateTime').textContent = 
                    `√öltima actualizaci√≥n: ${data.ultima_actualizacion || 'N/A'}`;

                // Actualizar Latest Moves
                updateLatestMoves(data.notificaciones || []);

                // Actualizar tablas de estad√≠sticas
                updateStatsTables(data.tablas || {});

                // Comprobar si hay nuevas notificaciones
                if (data.notificaciones && data.notificaciones.length > lastNotificationCount) {
                    lastNotificationCount = data.notificaciones.length;
                }

            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('latestMoves').innerHTML = 
                    '<p style="color: #ff6b6b;">Error cargando datos. Reintentando...</p>';
            }
        }

        function updateLatestMoves(notifications) {
            const container = document.getElementById('latestMoves');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<p>No hay movimientos recientes a√∫n...</p>';
                return;
            }

            // Mostrar las √∫ltimas 20 notificaciones
            const recentNotifications = notifications.slice(-20).reverse();
            
            container.innerHTML = recentNotifications.map((notif, index) => `
                <div class="notification-item ${index < 3 ? 'new' : ''}">
                    <div class="timestamp">${notif.hora || ''}</div>
                    <div class="notification-text">${notif.mensaje || ''}</div>
                </div>
            `).join('');
        }

        function updateStatsTables(tablas) {
            const container = document.getElementById('statsContainer');
            
            if (!tablas || Object.keys(tablas).length === 0) {
                container.innerHTML = '<div class="loading">No hay datos de partidos en vivo...</div>';
                return;
            }

            container.innerHTML = '';

            const statNames = {
                'PTS': 'Puntos',
                'AST': 'Asistencias',
                'REB': 'Rebotes',
                'STL': 'Robos',
                'BLK': 'Tapones',
                '3PM': 'Triples'
            };

            for (const [stat, jugadores] of Object.entries(tablas)) {
                const card = document.createElement('div');
                card.className = 'stat-card';
                
                const statName = statNames[stat] || stat;
                
                card.innerHTML = `
                    <h2>${statName}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>Hoy</th>
                                <th>Total</th>
                                <th>Diff</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${jugadores.slice(0, 10).map(j => `
                                <tr>
                                    <td>${j.Rank}</td>
                                    <td>${j.Nombre}</td>
                                    <td>${j.Team}</td>
                                    <td>${j.Hoy}</td>
                                    <td>${j.Total}</td>
                                    <td>${j.Diff || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.appendChild(card);
            }
        }

        // ============================================
        // INICIALIZACI√ìN Y ACTUALIZACI√ìN AUTOM√ÅTICA
        // ============================================
        // Cargar datos al iniciar
        loadData();

        // Actualizar cada 30 segundos
        setInterval(loadData, 30000);

        // Recargar cuando la p√°gina vuelve a ser visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadData();
            }
        });
    </script>
</body>
</html>
