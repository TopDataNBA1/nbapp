<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP DATA NBA LIVE</title>
    <link rel="manifest" href="/nbapp/manifest.json" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body{margin:0;padding:0;background:#0f0f1b;color:#e0e0e0;font-family:'Roboto',sans-serif;min-height:100vh;}
        .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:rgba(0,0,0,0.9);border-bottom:3px solid #ff4655;}
        .logo-img{height:60px;width:auto;}
        .nbapp{font-family:'Orbitron',sans-serif;font-size:2.4em;color:#ff4655;text-shadow:0 0 10px #ff4655;font-weight:700;}
        .status-bar{padding:8px 20px;background:rgba(0,0,0,0.7);font-size:1.1em;text-align:center;}
        .status-line1{color:#55ff55;}
        .status-line2{color:#ffaa00;font-weight:600;}
        .tabs{max-width:900px;margin:15px auto;display:flex;border-radius:10px;overflow:hidden;box-shadow:0 4px 15px rgba(255,70,85,0.3);}
        .tab-btn{flex:1;padding:12px 8px;font-family:'Orbitron',sans-serif;font-size:1.1em;color:white;background:rgba(255,70,85,0.2);border:none;cursor:pointer;transition:0.3s;}
        .tab-btn:hover{background:rgba(255,70,85,0.4);}
        .tab-btn.active{background:#ff4655;box-shadow:0 0 12px #ff4655;}
        .tab-content{display:none;background:rgba(20,20,40,0.97);padding:10px;border-radius:0 0 10px 10px;}
        .tab-content.active{display:block;}
        .container{max-width:900px;margin:0 auto;}
        .moves-area{height:88vh;background:#1e1e2e;border-radius:16px;overflow:hidden;box-shadow:0 12px 40px rgba(255,70,85,0.4);display:flex;flex-direction:column;}
        .moves-list{flex:1;overflow-y:auto;padding:18px 12px;background:#0f0f1b;}
        .move-item{background:rgba(30,30,46,0.9);border-radius:14px;margin:14px 8px;padding:16px 14px;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
        .move-text{font-size:1.01em;line-height:1.52;color:#e0e0e0;text-align:center;}
        .move-text strong{color:#ffaa00;font-weight:700;}
        .move-time{color:#888;font-size:0.89em;text-align:center;margin-top:10px;font-style:italic;}
        .filters{display:flex;gap:10px;margin:12px 0;justify-content:center;padding:4px 0;overflow-x:auto;}
        .filter-btn{white-space:nowrap;padding:6px 11px;background:rgba(255,70,85,0.25);border:1px solid #ff4655;border-radius:6px;font-family:'Orbitron',sans-serif;font-size:0.86em;cursor:pointer;transition:0.3s;}
        .filter-btn.active{background:#ff4655;box-shadow:0 0 10px #ff4655;font-weight:bold;}
        .card{background:rgba(20,20,40,0.97);border-radius:8px;overflow:hidden;margin:10px 0;box-shadow:0 4px 12px rgba(0,0,0,0.6);}
        .card h2{margin:0;padding:8px;font-family:'Orbitron',sans-serif;font-size:1.15em;background:#ff4655;color:white;text-align:center;}
        table{width:100%;border-collapse:collapse;font-size:0.84em;}
        th,td{padding:5px 4px;border-bottom:1px solid #333;}
        th{background:#1a1a2e;position:sticky;top:0;font-size:0.88em;}
        .rank{color:#ffaa00;text-align:center;font-weight:bold;width:8%;}
        .player{text-align:left;font-weight:500;width:28%;}
        .number,.today,.diff{text-align:right;}
        .today{font-weight:bold;width:12%;}
        .diff{color:#ffaa00;width:10%;}
        .diff-blink{color:#ffaa00!important;font-weight:900;animation:blink 1.6s infinite;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
        .leyenda{text-align:center;padding:10px;background:rgba(255,70,85,0.15);border:1px solid #ff4655;border-radius:8px;font-size:0.9em;margin:10px 0;}
        .collage {max-width:300px;max-height:200px;margin:0 auto 12px;}
        .collage img {width:100%;height:100%;object-fit:cover;border-radius:10px;}
        .collage.c1 img {width:100%;height:100%;object-fit:cover;}
        .collage.c2 {display:flex;gap:6px;}
        .collage.c2 img {flex:1;height:100%;object-fit:cover;}
        .collage.c3 {display:flex;gap:6px;height:200px;}
        .collage.c3 .left, .collage.c3 .right {flex:1;display:flex;flex-direction:column;gap:6px;}
        .collage.c3 .left img, .collage.c3 .right img {flex:1;width:100%;object-fit:cover;}
        .collage.c4 {display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:6px;height:200px;}
        .collage.c4 img {width:100%;height:100%;object-fit:cover;}
    </style>
</head>
<body>

    <div class="topbar">
        <img src="logo.jpg" alt="Logo" class="logo-img">
        <div class="nbapp">NBApp</div>
    </div>

    <div class="status-bar">
        <div class="status-line1">ONLINE - Last update:</div>
        <div class="status-line2" id="clock-line">--:--:-- ET ‚Ä¢ --:--:-- CEST</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('telegram')">Latest Moves</button>
        <button class="tab-btn" onclick="openTab('live')">Live Rankings</button>
    </div>

    <div id="telegram" class="tab-content active">
        <div class="container">
            <div class="moves-area">
                <div class="moves-list" id="moves-list-container">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <div id="live" class="tab-content">
        <div class="container">
            <div class="leyenda">Today column: <span style="color:white">game finished</span> ‚Ä¢ <span style="color:#ffaa00;text-shadow:0 0 8px #ffaa00">playing now</span> ‚Ä¢ <span style="color:#888">not started</span> ‚Ä¢ <span style="color:#ff5555">inactive</span></div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="top25">Top 25</button>
                <button class="filter-btn" data-filter="top100">Top 100</button>
                <button class="filter-btn" data-filter="playing">Playing</button>
                <button class="filter-btn" data-filter="almost">Almost</button>
            </div>
            <div id="tables"></div>
        </div>
    </div>

    <audio id="notifSound" src="ball.mp3" preload="auto"></audio>

    <script>
        const statNames = {pts:"NBA All-Time Points",trb:"NBA All-Time Rebounds",ast:"NBA All-Time Assists",stl:"NBA All-Time Steals",blk:"NBA All-Time Blocks",fg3:"NBA All-Time Three-Pointers",g:"NBA All-Time Games Played"};
        let lastNotificationCount = 0;
        let soundUnlocked = false;

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'live') updateLiveRankings();
            if (tabName === 'telegram') updateLatestMoves();
        }

        function getTimes() {
            const now = new Date();
            const cest = now.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:'Europe/Paris'});
            const est = now.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZone:'America/New_York'});
            return {cest, est};
        }
        
        function timeAgo(ts) {
            const diff = Math.floor((Date.now() / 1000) - ts);
            if (diff < 60) return "now";
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function getActiveFilters() {
            return {
                top25: document.querySelector('[data-filter="top25"]').classList.contains('active'),
                top100: document.querySelector('[data-filter="top100"]').classList.contains('active'),
                playing: document.querySelector('[data-filter="playing"]').classList.contains('active'),
                almost: document.querySelector('[data-filter="almost"]').classList.contains('active'),
                all: document.querySelector('[data-filter="all"]').classList.contains('active')
            };
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                if (filter === 'all') {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                } else {
                    document.querySelector('[data-filter="all"]').classList.remove('active');
                    if (filter === 'top25') document.querySelector('[data-filter="top100"]')?.classList.remove('active');
                    if (filter === 'top100') document.querySelector('[data-filter="top25"]')?.classList.remove('active');
                    this.classList.toggle('active');
                }
                updateLiveRankings();
            });
        });

        function updateLiveRankings(data) {
            const {cest, est} = getTimes();
            document.getElementById('clock-line').textContent = `${est} ET ‚Ä¢ ${cest} CEST`;
            
            const tablesDiv = document.getElementById('tables');
            tablesDiv.innerHTML = ''; 
            const filters = getActiveFilters();

            for (const [stat, tabla] of Object.entries(data.tablas || {})) {
                if (!tabla.length) continue;

                let filtered = tabla.filter(row => {
                    if (filters.top25 && row.Rank > 25) return false;
                    if (filters.top100 && !filters.top25 && row.Rank > 100) return false;
                    if (filters.playing && String(row.game_status || '').toLowerCase() !== 'playing') return false;
                    
                    if (filters.almost) {
                        const isPlayingOrNotStarted = ['playing', 'not_started'].includes(String(row.game_status || '').toLowerCase());
                        const diff = (row.Diff ?? '').toString().trim();
                        if (stat === 'g') {
                           if ((row.Hoy ?? 0) !== 0 || diff !== '0') return false;
                        } else {
                           const near = (stat === 'pts') ? ['0','1','2'] : ['0'];
                           if (!isPlayingOrNotStarted || !near.includes(diff)) return false;
                        }
                    }
                    return true;
                });

                if (filtered.length === 0) continue;

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<h2>${statNames[stat]}</h2><table><thead><tr><th>Rank</th><th>Player</th><th>Team</th><th>Today</th><th>Total</th><th>Diff</th><th>Ahead Of</th></tr></thead><tbody></tbody></table>`;
                const tbody = card.querySelector('tbody');

                filtered.forEach(row => {
                    const hoy = row.Hoy ?? 0;
                    const diff = (row.Diff ?? '').toString().trim() || '0';
                    const gameStatus = String(row.game_status || '').toLowerCase();
                    const isInactive = hoy === -1;
                    const isPoints = stat === 'pts';
                    const isGames = stat === 'g';
                    const near = isPoints ? ['0','1','2','3'] : ['0','1'];
                    const mustBlinkNormal = (isPlayingOrNotStarted && near.includes(diff) && !isInactive);
                    const mustBlinkGames = isGames && (isPlayingOrNotStarted && hoy === 0 && near.includes(diff));
                    const mustBlink = isGames ? mustBlinkGames : mustBlinkNormal;
                    
                    let todayStyle = 'color:#888'; // not started
                    if (isInactive) todayStyle = 'color:#ff5555'; // inactive
                    else if (gameStatus === 'finished') todayStyle = 'color:white';
                    else if (gameStatus === 'playing') todayStyle = 'color:#ffaa00;font-weight:900;text-shadow:0 0 12px #ffaa00';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="rank">${row.Rank}</td><td class="player">${row.Nombre}</td><td class="team">${row.Team}</td><td class="today" style="${todayStyle}">${hoy}</td><td class="number"><strong>${Number(row.Total).toLocaleString()}</strong></td><td class="diff number${mustBlink?' diff-blink':''}">${diff}</td><td>${row.Antece||'-'}</td>`;
                    tbody.appendChild(tr);
                });
                tablesDiv.appendChild(card);
            }
        }
        
        function updateLatestMoves(data) {
            const list = document.getElementById('moves-list-container');
            if (!list) return;

            const notis = (data.notificaciones || []).slice().reverse();
            if (notis.length === 0) {
                 list.innerHTML = '<div style="text-align:center;color:#888;padding:50px;">Waiting for tonight\'s action...</div>';
                 return;
            }

            list.innerHTML = notis.map(n => {
                const texto = n.texto || "";
                const fotos = Array.isArray(n.foto) ? n.foto : (n.foto ? [n.foto] : []);
                const cuando = n.timestamp ? timeAgo(n.timestamp) : "";
                
                let collageHtml = '';
                if (fotos.length > 0) {
                    const collageClass = `c${Math.min(fotos.length, 4)}`;
                    if (fotos.length < 3) {
                         collageHtml = `<div class="collage ${collageClass}">${fotos.map(f => `<img src="${f}" />`).join('')}</div>`;
                    } else if (fotos.length === 3) {
                        collageHtml = `<div class="collage c3"><div class="left"><img src="${fotos[0]}"/></div><div class="right"><img src="${fotos[1]}"/><img src="${fotos[2]}"/></div></div>`;
                    } else { // 4 or more
                        collageHtml = `<div class="collage c4">${fotos.slice(0,4).map(f => `<img src="${f}" />`).join('')}</div>`;
                    }
                }
                
                return `<div class="move-item">${collageHtml}<div class="move-text">${texto}</div><div class="move-time">${cuando}</div></div>`;
            }).join('');
        }
        
        function handleNewNotifications(data) {
             if (!data.notificaciones || data.notificaciones.length <= lastNotificationCount) {
                return;
            }

            const totalNuevas = data.notificaciones.length - lastNotificationCount;
            const newNotifications = data.notificaciones.slice(0, totalNuevas);
            
            console.log(`üèÄ ${totalNuevas} nuevas notificaciones detectadas!`);
            
            newNotifications.forEach(notif => {
                if (Notification.permission === 'granted') {
                    new Notification('üèÄ NBA Latest Move', {
                        body: notif.texto,
                        icon: notif.foto && notif.foto[0] ? `https://topdatanba1.github.io/nbapp/${notif.foto[0]}` : 'https://topdatanba1.github.io/nbapp/icon-192.png',
                        badge: 'https://topdatanba1.github.io/nbapp/icon-192.png',
                        silent: true 
                    });
                    
                    const audio = document.getElementById("notifSound");
                    audio.volume = 0.7;
                    audio.play().catch(e => console.log('Audio playback failed.', e));
                }
            });
            
            lastNotificationCount = data.notificaciones.length;
        }

        async function mainUpdateLoop() {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/TopDataNBA1/nbapp/main/data.json?t=${Date.now()}`);
                const data = await response.json();

                if (document.getElementById('telegram').classList.contains('active')) {
                    updateLatestMoves(data);
                }
                if (document.getElementById('live').classList.contains('active')) {
                    updateLiveRankings(data);
                }
                
                handleNewNotifications(data);

            } catch (error) {
                console.error('Error in main update loop:', error);
            }
        }

        function unlockSound() {
            if (soundUnlocked) return;
            const audio = document.getElementById("notifSound");
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                soundUnlocked = true;
                document.removeEventListener("click", unlockSound, true); // Clean up listener
            }).catch(() => {});
        }
        document.addEventListener("click", unlockSound, true);

        // --- INITIALIZATION ---
        (async () => {
            // 1. Register Service Worker & Request Permissions
            if ('serviceWorker' in navigator && 'Notification' in window) {
                try {
                    const registration = await navigator.serviceWorker.register('/nbapp/service-worker.js');
                    console.log('Service Worker registrado:', registration);
                    
                    if (Notification.permission === 'default') {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            console.log('Permisos de notificaci√≥n concedidos.');
                        }
                    }
                } catch (error) {
                    console.error('Error registrando Service Worker:', error);
                }
            }
            
            // 2. Initial data load and UI update
            try {
                const response = await fetch(`https://raw.githubusercontent.com/TopDataNBA1/nbapp/main/data.json?t=${Date.now()}`);
                const data = await response.json();
                if (data.notificaciones) {
                    lastNotificationCount = data.notificaciones.length;
                }
                updateLatestMoves(data);
                updateLiveRankings(data);
            } catch (error) {
                console.error('Initial data load failed:', error);
            }

            // 3. Start the main update loop
            setInterval(mainUpdateLoop, 10000); 
        })();

    </script>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "45aad425429240e08f69e0b5e6aedd75"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>