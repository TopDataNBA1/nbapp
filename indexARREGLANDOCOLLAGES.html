<!-- AUTO-GENERATED: DO NOT EDIT MANUALLY -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP DATA NBA LIVE</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <!-- Inline favicon to avoid /favicon.ico 404 -->
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23ff4655'/><text x='50' y='55' font-size='40' text-anchor='middle' fill='white' font-family='Orbitron, sans-serif'>NB</text></svg>">
    <style>
        body{margin:0;padding:0;background:#0f0f1b;color:#e0e0e0;font-family:'Roboto',sans-serif;min-height:100vh;}
        .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:rgba(0,0,0,0.9);border-bottom:3px solid #ff4655;}
        .logo-img{height:60px;width:auto;}
        .nbapp{font-family:'Orbitron',sans-serif;font-size:2.4em;color:#ff4655;text-shadow:0 0 10px #ff4655;font-weight:700;}
        .status-bar{padding:8px 20px;background:rgba(0,0,0,0.7);font-size:1.1em;text-align:center;}
        .status-line1{color:#55ff55;}
        .status-line2{color:#ffaa00;font-weight:600;}

        .tabs{max-width:900px;margin:15px auto;display:flex;border-radius:10px;overflow:hidden;box-shadow:0 4px 15px rgba(255,70,85,0.3);}
        .tab-btn{flex:1;padding:12px 8px;font-family:'Orbitron',sans-serif;font-size:1.1em;color:white;background:rgba(255,70,85,0.2);border:none;cursor:pointer;transition:0.3s;}
        .tab-btn:hover{background:rgba(255,70,85,0.4);}
        .tab-btn.active{background:#ff4655;box-shadow:0 0 12px #ff4655;}

        .tab-content{display:none;background:rgba(20,20,40,0.97);padding:10px;border-radius:0 0 10px 10px;}
        .tab-content.active{display:block;}
        .container{max-width:900px;margin:0 auto;}

        .moves-area{height:70vh;background:#1e1e2e;border-radius:16px;overflow:hidden;box-shadow:0 12px 40px rgba(255,70,85,0.4);display:flex;flex-direction:column;}
        .moves-list{flex:1;overflow-y:auto;padding:18px 12px;background:#0f0f1b;}
        .move-item{background:rgba(30,30,46,0.9);border-radius:14px;margin:14px 8px;padding:16px 14px;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
        .move-photos{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:12px;}
        .move-photos img{width:78px;height:78px;border-radius:50%;object-fit:cover;border:4px solid #ff4655;box-shadow:0 0 15px rgba(255,70,85,0.6);}
        .move-text{font-size:1.01em;line-height:1.52;color:#e0e0e0;text-align:center;}
        .move-text strong{color:#ffaa00;font-weight:700;}
        .move-time{color:#888;font-size:0.89em;text-align:center;margin-top:10px;font-style:italic;}

        .filters{display:flex;gap:10px;margin:12px 0;justify-content:center;padding:4px 0;overflow-x:auto;}
        .filter-btn{white-space:nowrap;padding:6px 11px;background:rgba(255,70,85,0.25);border:1px solid #ff4655;border-radius:6px;font-family:'Orbitron',sans-serif;font-size:0.86em;cursor:pointer;transition:0.3s;}
        .filter-btn.active{background:#ff4655;box-shadow:0 0 10px #ff4655;font-weight:bold;}

        .card{background:rgba(20,20,40,0.97);border-radius:8px;overflow:hidden;margin:10px 0;box-shadow:0 4px 12px rgba(0,0,0,0.6);}
        .card h2{margin:0;padding:8px;font-family:'Orbitron',sans-serif;font-size:1.15em;background:#ff4655;color:white;text-align:center;}
        table{width:100%;border-collapse:collapse;font-size:0.84em;}
        th,td{padding:5px 4px;border-bottom:1px solid #333;}
        th{background:#1a1a2e;position:sticky;top:0;font-size:0.88em;}
        .rank{color:#ffaa00;text-align:center;font-weight:bold;width:8%;}
        .player{text-align:left;font-weight:500;width:28%;}
        .number,.today,.diff{text-align:right;}
        .today{font-weight:bold;width:12%;}
        .diff{color:#ffaa00;width:10%;}
        .diff-blink{color:#ffaa00!important;font-weight:900;animation:blink 1.6s infinite;}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
        .leyenda{text-align:center;padding:10px;background:rgba(255,70,85,0.15);border:1px solid #ff4655;border-radius:8px;font-size:0.9em;margin:10px 0;}
        .collage { width:100%; margin-bottom:12px; overflow:hidden; border-radius:12px; border:4px solid #ff4655; box-shadow:0 0 15px rgba(255,70,85,0.6); }
    </style>
</head>
<body>

    <div class="topbar">
        <img src="logo.jpg" alt="Logo" class="logo-img">
        <div class="nbapp">NBApp</div>
    </div>

    <div class="status-bar">
        <div class="status-line1">ONLINE - Last update:</div>
        <div class="status-line2" id="clock-line">--:--:-- ET • --:--:-- CEST</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('telegram')">Latest Moves</button>
        <button class="tab-btn" onclick="openTab('live')">Live Rankings</button>
    </div>

    <!-- LATEST MOVES -->
    <div id="telegram" class="tab-content active">
        <div class="container">
            <div class="moves-area">
                <div class="moves-list">
                    <div id="moves-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- LIVE RANKINGS -->
    <div id="live" class="tab-content">
        <div class="container">
            <div class="leyenda">
                Today column: <span style="color:white">game finished</span> • 
                <span style="color:#ffaa00;text-shadow:0 0 8px #ffaa00">playing now</span> • 
                <span style="color:#888">not started</span> • 
                <span style="color:#ff5555">inactive</span>
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="top25">Top 25</button>
                <button class="filter-btn" data-filter="top100">Top 100</button>
                <button class="filter-btn" data-filter="playing">Playing</button>
                <button class="filter-btn" data-filter="almost">Almost</button>
            </div>
            <div id="tables"></div>
        </div>
    </div>

    <script>
        console.log('NBApp script loaded');

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const tab = document.getElementById(tabName);
            if (tab) tab.classList.add('active');
            const btn = document.querySelector(`button[onclick="openTab('${tabName}')"]`);
            if (btn) btn.classList.add('active');
            if (tabName === 'live') updatePage();
            if (tabName === 'telegram') updateMoves();
        }

        const statNames = {pts:"NBA All-Time Points",trb:"NBA All-Time Rebounds",ast:"NBA All-Time Assists",stl:"NBA All-Time Steals",blk:"NBA All-Time Blocks",fg3:"NBA All-Time Three-Pointers",g:"NBA All-Time Games Played"};

        function getTimes() {
            const now = new Date();
            const cest = now.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:'Europe/Paris'});
            const est = now.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZone:'America/New_York'});
            return {cest, est};
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    if (filter === 'all') {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    } else {
                        document.querySelector('[data-filter="all"]')?.classList.remove('active');
                        if (filter === 'top25') document.querySelector('[data-filter="top100"]')?.classList.remove('active');
                        if (filter === 'top100') document.querySelector('[data-filter="top25"]')?.classList.remove('active');
                        this.classList.toggle('active');
                    }
                    updatePage();
                });
            });

            updatePage();
            updateMoves();
        });

        function getActiveFilters() {
            return {
                top25: document.querySelector('[data-filter="top25"]')?.classList.contains('active'),
                top100: document.querySelector('[data-filter="top100"]')?.classList.contains('active'),
                playing: document.querySelector('[data-filter="playing"]')?.classList.contains('active'),
                almost: document.querySelector('[data-filter="almost"]')?.classList.contains('active'),
                all: document.querySelector('[data-filter="all"]')?.classList.contains('active')
            };
        }

        function updatePage() {
            try {
                const {cest, est} = getTimes();
                const clockLine = document.getElementById('clock-line');
                if (clockLine) clockLine.textContent = `${est} ET • ${cest} CEST`;

                fetch('data.json?v=' + new Date().getTime())
                    .then(r => r.ok ? r.json() : Promise.reject())
                    .then(data => {
                        const tablesDiv = document.getElementById('tables');
                        if (!tablesDiv) return;
                        tablesDiv.innerHTML = '';
                        const filters = getActiveFilters();

                        for (const [stat, tabla] of Object.entries(data.tablas || {})) {
                            if (!tabla.length) continue;

                            let filtered = tabla.filter(row => {
                                const rank = row.Rank;
                                const gameStatus = String(row.game_status || '').toLowerCase();
                                const hoy = row.Hoy ?? 0;
                                const diff = (row.Diff ?? '').toString().trim() || '0';

                                if (filters.top25 && rank > 25) return false;
                                if (filters.top100 && !filters.top25 && rank > 100) return false;
                                if (filters.playing && gameStatus !== 'playing') return false;

                                if (filters.almost) {
                                    if (stat === 'g') {
                                        if (hoy !== 0 || !['0'].includes(diff)) return false;
                                    } else {
                                        const isPlayingOrNotStarted = (gameStatus === 'playing' || gameStatus === 'not_started');
                                        const near = (stat === 'pts') ? ['0','1','2'] : ['0'];
                                        if (!isPlayingOrNotStarted || !near.includes(diff)) return false;
                                    }
                                }

                                return true;
                            });

                            if (filtered.length === 0) continue;

                            const card = document.createElement('div'); card.className = 'card';
                            card.innerHTML = `<h2>${statNames[stat]}</h2><table><thead><tr><th>Rank</th><th>Player</th><th>Before</th><th>Today</th><th>Total</th><th>Diff</th><th>Ahead Of</th></tr></thead><tbody></tbody></table>`;
                            const tbody = card.querySelector('tbody');

                            filtered.forEach(row => {
                                const hoy = row.Hoy ?? 0;
                                const diff = (row.Diff ?? '').toString().trim() || '0';
                                const gameStatus = String(row.game_status || '').toLowerCase();
                                const isInactive = hoy === -1;

                                const isPoints = stat === 'pts';
                                const isGames = stat === 'g';
                                const near = isPoints ? ['0','1','2','3'] : ['0','1'];
                                const mustBlinkNormal = (gameStatus === 'playing' || gameStatus === 'not_started') && near.includes(diff) && !isInactive;
                                const mustBlinkGames = isGames && (gameStatus === 'playing' || gameStatus === 'not_started') && hoy === 0 && near.includes(diff);
                                const mustBlink = isGames ? mustBlinkGames : mustBlinkNormal;

                                let todayStyle = '';
                                if (isInactive) todayStyle = 'color:#ff5555';
                                else if (gameStatus === 'finished') todayStyle = 'color:white';
                                else if (gameStatus === 'playing') todayStyle = 'color:#ffaa00;font-weight:900;text-shadow:0 0 12px #ffaa00';
                                else todayStyle = 'color:#888';

                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td class="rank">${row.Rank}</td>
                                    <td class="player">${row.Nombre}</td>
                                    <td class="number">${Number(row.Antes).toLocaleString()}</td>
                                    <td class="today" style="${todayStyle}">${hoy}</td>
                                    <td class="number"><strong>${Number(row.Total).toLocaleString()}</strong></td>
                                    <td class="diff number${mustBlink?' diff-blink':''}">${diff}</td>
                                    <td>${row.Antece||'-'}</td>`;
                                tbody.appendChild(tr);
                            });
                            tablesDiv.appendChild(card);
                        }
                    }).catch(e => { console.warn('No data.json or parse error', e); });
            } catch (e) { console.error('updatePage error', e); }
        }

        async function updateMoves() {
            try {
                const list = document.getElementById('moves-list');
                if (!list) return;
                const r = await fetch('data.json?v=' + new Date().getTime());
                const data = await r.json();
                const notis = (data.notificaciones || []).reverse();

                list.innerHTML = notis.map(n => {
                    const isString = (typeof n === 'string');
                    const texto = isString ? n : (n.texto || "");
                    const fotos = isString ? [] : (Array.isArray(n.foto) ? n.foto : (n.foto ? [n.foto] : []));

                    if (fotos.length === 0) return `<div class="move-item"><div class="move-text">${texto}</div></div>`;
                    if (fotos.length === 1) return `<div class="move-item"><div class="collage c1"><img src="${fotos[0]}" /></div><div class="move-text">${texto}</div></div>`;
                    if (fotos.length === 2) return `<div class="move-item"><div class="collage c2"><img src="${fotos[0]}" /><img src="${fotos[1]}" /></div><div class="move-text">${texto}</div></div>`;
                    if (fotos.length === 3) return `<div class="move-item"><div class="collage c3"><div class="left"><img src="${fotos[0]}" /></div><div class="right"><img src="${fotos[1]}" /><img src="${fotos[2]}" /></div></div><div class="move-text">${texto}</div></div>`;
                    return `<div class="move-item"><div class="collage c4">${fotos.slice(0,4).map(f=>`<img src="${f}" />`).join('')}</div><div class="move-text">${texto}</div></div>`;
                }).join('');

                const latest = notis[0];
                if (latest) {
                    const isString = (typeof latest === 'string');
                    const texto = isString ? latest : (latest.texto || '');
                    const fotos = isString ? [] : (Array.isArray(latest.foto) ? latest.foto : (latest.foto ? [latest.foto] : []));
                    const hash = btoa(unescape(encodeURIComponent(JSON.stringify({texto,fotos}))));
                    const lastHash = localStorage.getItem('last_move_hash');
                    console.log('updateMoves: latest', {texto,fotos,hash,lastHash,permission: Notification.permission});
                    if (hash !== lastHash) {
                        if ('Notification' in window && Notification.permission === 'default') {
                            const perm = await Notification.requestPermission();
                            console.log('Permission result:', perm);
                        }
                        if (window.Notification && Notification.permission === 'granted') {
                            let dataUrl = null;
                            try { dataUrl = await buildCollageDataUrl(fotos); } catch (e) { console.warn('buildCollageDataUrl error', e); }
                            const options = { body: texto || 'NBApp update', tag: 'nbapp-move', renotify: false };
                            if (dataUrl) { options.icon = dataUrl; options.image = dataUrl; }
                            else if (fotos && fotos.length) { options.icon = fotos[0]; options.image = fotos[0]; }
                            try { new Notification('NBApp', options); console.log('Notification shown', options); } catch (e) { console.warn('Notification failed', e); }
                        } else {
                            console.warn('Notifications not granted - permission:', Notification.permission);
                        }
                        localStorage.setItem('last_move_hash', hash);
                    } else {
                        console.log('updateMoves: duplicate, skipping');
                    }
                }
            } catch (e) { console.error('updateMoves error', e); }
        }

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Image load error ' + url));
                img.src = url;
            });
        }

        function drawImageCover(ctx, img, x, y, w, h) {
            const iw = img.width, ih = img.height;
            const scale = Math.max(w / iw, h / ih);
            const sw = w / scale, sh = h / scale;
            const sx = Math.max(0, (iw - sw) / 2);
            const sy = Math.max(0, (ih - sh) / 2);
            ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
        }

        async function buildCollageDataUrl(fotos) {
            if (!fotos || fotos.length === 0) return null;
            const size = 512;
            const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#0f0f1b'; ctx.fillRect(0,0,size,size);
            const imgs = fotos.slice(0,4);
            try {
                const loaded = await Promise.all(imgs.map(u => loadImage(u).catch(()=>null)));
                const valid = loaded.filter(Boolean);
                if (valid.length === 0) return null;
                if (valid.length === 1) drawImageCover(ctx, valid[0], 0, 0, size, size);
                else if (valid.length === 2) { drawImageCover(ctx, valid[0], 0, 0, size/2, size); drawImageCover(ctx, valid[1], size/2, 0, size/2, size); }
                else if (valid.length === 3) { drawImageCover(ctx, valid[0], 0, 0, size/2, size); drawImageCover(ctx, valid[1], size/2, 0, size/2, size/2); drawImageCover(ctx, valid[2], size/2, size/2, size/2, size/2); }
                else { drawImageCover(ctx, valid[0], 0, 0, size/2, size/2); drawImageCover(ctx, valid[1], size/2, 0, size/2, size/2); drawImageCover(ctx, valid[2], 0, size/2, size/2, size/2); drawImageCover(ctx, valid[3], size/2, size/2, size/2, size/2); }
                ctx.lineWidth = 18; ctx.strokeStyle = '#ff4655'; ctx.strokeRect(9,9,size-18,size-18);
                return canvas.toDataURL('image/png');
            } catch (e) { console.warn('buildCollageDataUrl failed', e); return null; }
        }

        // Helper para testear notificaciones desde la consola
        window.notiTest = async function(payload) {
            try {
                const texto = payload?.texto || payload?.text || (typeof payload === 'string' ? payload : 'Test notification');
                const fotos = payload?.foto || payload?.fotos || [];
                if ('Notification' in window && Notification.permission === 'default') {
                    const perm = await Notification.requestPermission();
                    console.log('Permission result:', perm);
                }
                if (Notification.permission !== 'granted') {
                    console.warn('Notification permission not granted:', Notification.permission);
                    return;
                }
                const dataUrl = await buildCollageDataUrl(Array.isArray(fotos) ? fotos : (fotos ? [fotos] : []));
                const options = { body: texto, tag: 'nbapp-move-test', renotify: true };
                if (dataUrl) { options.icon = dataUrl; options.image = dataUrl; }
                else if (fotos && fotos.length) { options.icon = fotos[0]; options.image = fotos[0]; }
                new Notification('NBApp Test', options);
                console.log('notiTest sent', options);
            } catch (e) { console.error('notiTest error', e); }
        };

        // Nota: la función de test de notificación ha sido eliminada para producción.

        // periodic updater
        setInterval(() => { if (document.getElementById('telegram')?.classList.contains('active')) updateMoves(); if (document.getElementById('live')?.classList.contains('active')) updatePage(); }, 25000);
    </script>
</body>
</html>
